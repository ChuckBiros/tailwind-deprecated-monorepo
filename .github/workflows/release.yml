name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # =============================================================================
  # Build & Release
  # =============================================================================
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      # LSP Server - use root npm for monorepo
      - name: Install dependencies
        run: npm ci
      
      - name: Run LSP server tests
        run: npm test -w lsp-server
      
      - name: Build LSP server
        run: npm run build -w lsp-server
      
      # Plugin
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Build plugin
        working-directory: plugin
        run: ./gradlew buildPlugin --no-daemon
      
      # GitHub Release
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            plugin/build/distributions/*.zip
          body: |
            ## Tailwind Deprecated Plugin v${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            **Manual Installation:**
            1. Download the `.zip` file from this release
            2. Open Rider → Settings → Plugins → ⚙️ → Install Plugin from Disk
            3. Select the downloaded `.zip` file
            
            ### Requirements
            - Rider 2023.3 or later
            - Node.js 18+ (for the LSP server)
            
            ### Changelog
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
