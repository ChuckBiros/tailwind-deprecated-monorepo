name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # =============================================================================
  # Build & Release
  # =============================================================================
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      # LSP Server
      - name: Install LSP server dependencies
        working-directory: lsp-server
        run: npm ci
      
      - name: Run LSP server tests
        working-directory: lsp-server
        run: npm run test
      
      - name: Build LSP server
        working-directory: lsp-server
        run: npm run build
      
      - name: Install production dependencies
        working-directory: lsp-server
        run: npm ci --production
      
      # Plugin
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      
      - name: Build plugin
        working-directory: plugin
        run: ./gradlew buildPlugin
      
      - name: Verify plugin
        working-directory: plugin
        run: ./gradlew verifyPlugin
      
      # Publish to JetBrains Marketplace
      - name: Publish to JetBrains Marketplace
        working-directory: plugin
        env:
          PUBLISH_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}
        run: ./gradlew publishPlugin
      
      # GitHub Release
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            plugin/build/distributions/*.zip
          body: |
            ## Tailwind Deprecated Plugin v${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            **JetBrains Marketplace (Recommended):**
            1. Open Rider → Settings → Plugins
            2. Search for "Tailwind Deprecated"
            3. Click Install
            
            **Manual Installation:**
            1. Download the `.zip` file from this release
            2. Open Rider → Settings → Plugins → ⚙️ → Install Plugin from Disk
            3. Select the downloaded `.zip` file
            
            ### Requirements
            - Rider 2023.3 or later
            - Node.js 18+ (for the LSP server)
            
            ### Changelog
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


